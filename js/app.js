require('../css/styles.scss')
var $ = require('jquery')
var d3 = require('d3')
var _ = require('underscore')

$("#all-spills-viz").append("<div class='tip'></div>");
$(".tip").hide();

var windowWidth = $(window).width(),
windowHeight = 160,
margin = {top: 30, bottom: 30, left: 40, right: 40}

var width = $(window).width();
var height = (windowWidth>450)?400:500
var buffer = 50
windowWidth = (windowWidth>1200)?1200:windowWidth
// scrolly for the kkhh nav
 $(window).scroll(function() {
        var windscroll = $(window).scrollTop();
        
        
        if ($('.copy-container').position().top <= windscroll + buffer ) {
            if (!$('.progress-nav').hasClass('fixed')){
                $('.progress-nav').addClass('fixed')
                $('.copy-container').addClass('gap')
            }

            $('.section-container').each(function(i) {
                if ($(this).position().top <= windscroll &&  $('.copy-container').hasClass('gap')) {
                    $('.s-dot.active').removeClass('active');
                    $('.s-dot').eq(i).addClass('active');
                    var progress = (windscroll + (buffer*3) - $(this).position().top)/($(this).height())
                   
                    if (progress<=100){
                        var comp = i*25 + (progress*25)+"%"
                        $('.progress').width(comp)
                    }
                }
            })

        } else {
            $('.progress-nav').removeClass('fixed')
            $('.copy-container').removeClass('gap')
            $('.progress').width('0%')
        }

}).scroll();


// d3 viz for all spills
d3.csv('data/all-oil-spills.csv',function(error,data){

    var yearlist = [];
    for (var i = 1982; i <= d3.max(data,function(e){return e.year}); i++) {
        yearlist.push(i);
    }

    var yearnest = d3.nest()
                    .key(function(d) { return d.year; })
                    .entries(data);

    var x = d3.scaleBand()
        .domain(yearlist)
        .range([0, (windowWidth-margin.left-margin.right)])
        .padding([0.4]);

    var y =  d3.scaleLinear() 
        .domain([d3.max(yearnest,function(e){return e.values.length}),0])
        .range([0, (windowHeight-margin.top-margin.bottom)]);

    var blockheight = 10

    var xAxis = d3.axisBottom()
    .scale(x)

        xAxis.tickValues([1982, 1990, 2000 ,2010, 2017])
        .tickFormat(function(e){
            if (e>1982 && e!=2000 && e!=2017){
                return "'"+(e).toString().slice(-2);
            }else {return e}
         
    })
     if (windowWidth<800){
        var box_width = Math.floor(0.85*windowWidth)
    }   else {
        var box_width = Math.floor(0.6*windowWidth)
    }

    var svg = d3.select('#all-spills-viz')
        .append('svg')
        .attr('class','chart-container')
        .attr('width',windowWidth)
        .attr('height',windowHeight)


    svg.append('g')
        .attr('class','chart-container-g')
        .attr('width',windowWidth - margin.left - margin.right)
        .attr('height',windowHeight - margin.top - margin.bottom)
        .attr('transform','translate('+margin.left+','+0+')')
        .append('g')
        .attr('class','chart')
        .selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
        .attr('class',function(d,i){return 'spill s-'+i })
        .attr('x', function(d) { return x(+d['year']) })
        .attr('y', function(d) { 
            var obj = _.findWhere(yearnest, {key:d['year']})
            return y(obj.values.getIndexBy("spilled_by", d.spilled_by))
        })
        .attr('width', x.bandwidth())
        .attr('height', blockheight)
        .style('fill',function(d){return getColor(d.quantity)})
        .on("mouseover", tipOn)
        .on("mouseout", tipOff);
// x axis
d3.selectAll('.chart-container-g')
        .append('g')
        .attr("class", "x axis")
      .attr("transform", "translate(0,"+ (windowHeight-margin.top-(margin.bottom/2)) +")")
      .call(xAxis)

      // tooltips
svg.on("mouseout", function(){
  $(".tip").hide()
});

 function tipOn(d, i){

      var dat = d;
    var elem = ".spill.s-" + i;
      $(".tip").empty();

      // show
      $(".tip").show();
      $(".spill").removeClass("highlight");
      $(elem).addClass("highlight");
      // populate
      $(".tip").append("<div class='name'>" + dat.spilled_by + "</div>");
      $(".tip").append("<div class='date'>" + dat.date + "</div>");
      $(".tip").append("<div class='location'><b>Location:</b> " + dat.location + "</div>");
      $(".tip").append("<div class='quantity'><b>Quantity:</b> " + (dat.quantity.match(/[0123456789]/g)?dat.quantity+" tonnes":"Unknown") + "</div>");

      var blockheight = 10
      // position

      // calculate top
      function calcTop(d){
        var obj = _.findWhere(yearnest, {key:d['year']})
        var y2 =  y(obj.values.getIndexBy("spilled_by", d.spilled_by))
        var h = $(".tip").height();
        var ot = $("svg").offset().top;
        var st = $(window).scrollTop();
        var r = blockheight*3.5;
        var t = y2 - r - h + ot - st + 10 ;

        if (t < 40){
          t = y2 + (h/2.7) + ot - st + 10;
          $(".tip").addClass("bottom").removeClass("top");
        } else {
          $(".tip").addClass("top").removeClass("bottom");
        }
        return t;
      }

      function calcLeft(d){
        var x2 = x(d.year);
        var r = x.bandwidth()/2;
        var w = $(".tip").width();
        var l = x2 - w / 2 + r;
        var m = ($(window).width()>1200 ? 0 : margin.left-r)
        return x2-r-m;
      }

      $(".tip").css({
        top: calcTop(dat),
        left: calcLeft(dat)
      });

      $(window).resize(function(){
        $(".tip").css({
          top: calcTop(dat),
          left: calcLeft(dat)
        });
      });
    }

    function tipOff(d){
      $(".spill").removeClass("highlight");
    }

})

Array.prototype.getIndexBy = function (name, value) {
    for (var i = 0; i < this.length; i++) {
        if (this[i][name] == value) {
            return i;
        }
    }
    return -1;
}

function getColor(e){
    if (!e.match(/[0-9]/)){
        return "#bbb"
    } else if (+e < 700){
        return "#EBD1D0"
    } else if (+e < 10000){
        return "#D5A1A0"
    } else {
        return "#AD4746"
    }
}

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};
d3.selection.prototype.moveToBack = function() {
    return this.each(function() {
        var firstChild = this.parentNode.firstChild;
        if (firstChild) {
            this.parentNode.insertBefore(this, firstChild);
        }
    });
};

var chennai = [ 80.2707,13.0827]
mapboxgl.accessToken = 'pk.eyJ1IjoiaGluZHVzdGFudGltZXMiLCJhIjoiY2l2ajVnbHFhMDFocTJvdG1qdjZ4dTR6diJ9.LHCdUER7Fh2rojs2Km7gRA';
var framesPerSecond = 15; 
var initialOpacity = 1
var opacity = initialOpacity;
var initialRadius = 9;
var radius = initialRadius;
var maxRadius = 15;
var map = new mapboxgl.Map({
   container: 'map',
   style: 'mapbox://styles/hindustantimes/civj68cq600d62kl8k7bdbd1d',
   center: chennai,
   pitch: 40, // pitch in degrees
   bearing: -5, // bearing in degrees
   zoom: 5,
   dragPan: false,
   dragRotate: false,
   scrollZoom: false,
   touchZoomRotate: false,
   doubleClickZoom: false
});

var maple = [ 80.34988403320312,13.27102384021512]
var dawn = [80.43176651000977,13.220227075362656]
var dawndest = [
            80.36632061004639,
            13.227705224762586
          ]
var mapledest = [
          80.38198471069336,
          13.213375385243596
        ]
var centernew = [
          80.36842346191405,
          13.227412787475556
        ]

var json = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[80.43176651000977,13.22056129922611],[80.43176651000977,13.220916411579182],[80.43174505233765,13.221208856658166],[80.43170213699341,13.221543079176154],[80.43168067932129,13.221856412370762],[80.43138027191162,13.222086189790945],[80.43107986450195,13.222315966994623],[80.43086528778076,13.222545743981781],[80.43067216873169,13.222796409539026],[80.43039321899414,13.223026186073465],[80.43004989624023,13.223193296144343],[80.42968511581421,13.22327685113682],[80.42938470840454,13.22327685113682],[80.42901992797852,13.223255962391383],[80.42856931686401,13.223297739880465],[80.42829036712645,13.223297739880465],[80.42794704437254,13.223297739880465],[80.42760372161864,13.223318628622328],[80.4274320602417,13.223297739880465],[80.42713165283203,13.223297739880465],[80.42674541473389,13.223318628622328],[80.42640209197998,13.223297739880465],[80.42605876922607,13.223172407391743],[80.42573690414429,13.223088852363466],[80.4254150390625,13.222942630995087],[80.42509317398071,13.222879964667504],[80.42479276657104,13.222796409539026],[80.42444944381714,13.22271285438191],[80.42414903640747,13.222608410395251],[80.4238486289978,13.222503966363861],[80.4235053062439,13.222399522287738],[80.42314052581787,13.222253300506003],[80.42275428771973,13.222148856322518],[80.42251825332642,13.222065300943527],[80.42213201522827,13.22193996782134],[80.42185306549072,13.221835523503648],[80.42168140411376,13.221793745764053],[80.42163848876953,13.221751968017294],[80.42133808135986,13.221647523619085],[80.42101621627808,13.2215848569587],[80.42086601257324,13.221480412488914],[80.42050123214722,13.221313301244244],[80.42020082473755,13.221167078811208],[80.41987895965576,13.221083523095828],[80.41951417922974,13.220958189469078],[80.41904211044312,13.220811966823135],[80.41852712631226,13.220665744089521],[80.41829109191895,13.220623966149526],[80.41792631149292,13.220519521268226],[80.41754007339478,13.220435965330998],[80.41717529296875,13.220331520369193],[80.41683197021484,13.22024796436754],[80.41627407073975,13.22008085227838],[80.41575908660887,13.219892851041191],[80.41490077972412,13.219725738708709],[80.41449308395386,13.219642182499529],[80.41406393051147,13.219537737197811],[80.41369915008545,13.219433291851363],[80.41344165802002,13.2194124027767],[80.41305541992188,13.219328846460183],[80.41266918182373,13.219287068291187],[80.41226148605347,13.219161733741275],[80.41193962097168,13.219099066442173],[80.41146755218506,13.218973731795648],[80.41123151779175,13.218952842681636],[80.41108131408691,13.218890175328857],[80.41086673736572,13.218869286207694],[80.4106092453003,13.218785729705116],[80.41043758392334,13.218785729705116],[80.41033029556274,13.218723062309413],[80.4101800918579,13.218681284036656],[80.40998697280884,13.218618616614108],[80.409836769104,13.218618616614108],[80.40968656539917,13.218576838323463],[80.40947198867798,13.218576838323463],[80.40934324264526,13.218514170874098],[80.40910720825195,13.218472392565566],[80.40887117385863,13.218388835927037],[80.40861368179321,13.218305279259896],[80.4083776473999,13.218284390088646],[80.40818452835083,13.218284390088646],[80.4079270362854,13.218221722564119],[80.40764808654785,13.218221722564119],[80.40745496749878,13.218221722564119],[80.40721893310545,13.218221722564119],[80.40696144104004,13.218200833385705],[80.40663957595825,13.218200833385705],[80.40631771087646,13.21817994420551],[80.40614604949951,13.21813816583974],[80.40599584579468,13.21813816583974],[80.40584564208984,13.21813816583974],[80.40548086166382,13.218117276654164],[80.4052448272705,13.218096387466808],[80.40503025054932,13.218096387466808],[80.40460109710692,13.21813816583974],[80.40421485900879,13.21813816583974],[80.40380716323853,13.21813816583974],[80.4034423828125,13.21813816583974],[80.40314197540283,13.21813816583974],[80.40264844894409,13.218096387466808],[80.40234804153442,13.218096387466808],[80.40194034576416,13.218096387466808],[80.40148973464966,13.218075498277669],[80.40097475051878,13.218075498277669],[80.40043830871582,13.218075498277669],[80.3999662399292,13.218075498277669],[80.39968729019165,13.218054609086712],[80.39947271347046,13.218054609086712],[80.39923667907715,13.218075498277669],[80.3989577293396,13.218075498277669],[80.39876461029053,13.218075498277669],[80.3986144065857,13.218075498277669],[80.39824962615967,13.218075498277669],[80.39786338806152,13.218075498277669],[80.39762735366821,13.218075498277669],[80.39730548858643,13.218096387466808],[80.39706945419312,13.218117276654164],[80.3968334197998,13.218117276654164],[80.3965973854065,13.218117276654164],[80.39625406265259,13.218096387466808],[80.39597511291504,13.218096387466808],[80.39580345153809,13.218096387466808],[80.39554595947266,13.218096387466808],[80.39513826370239,13.218096387466808],[80.39485931396484,13.218096387466808],[80.39462327957153,13.218096387466808],[80.39438724517821,13.218096387466808],[80.3940224647522,13.218096387466808],[80.39361476898193,13.218117276654164],[80.39337873458862,13.218117276654164],[80.3931212425232,13.21813816583974],[80.39269208908081,13.21815905502351],[80.39217710494995,13.21815905502351],[80.39151191711426,13.21815905502351],[80.39097547531128,13.21817994420551],[80.3903317451477,13.21817994420551],[80.3898811340332,13.21817994420551],[80.3893232345581,13.21817994420551],[80.38893699645996,13.21817994420551],[80.38859367370605,13.218200833385705],[80.38827180862427,13.218200833385705],[80.38799285888672,13.21824261174075],[80.38771390914917,13.218284390088646],[80.38760662078857,13.218263500915588],[80.38726329803467,13.218347057597041],[80.38674831390381,13.218430614249883],[80.38636207580566,13.218430614249883],[80.38601875305176,13.218430614249883],[80.38558959960938,13.218430614249883],[80.3852891921997,13.218430614249883],[80.38498878479004,13.218430614249883],[80.38464546203613,13.218430614249883],[80.38434505462646,13.218597727469689],[80.38400173187256,13.218848397084725],[80.38361549377441,13.218848397084725],[80.38305759429932,13.218848397084725],[80.38267135620117,13.218848397084725],[80.38232803344727,13.218848397084725],[80.38207054138184,13.218848397084725],[80.38155555725098,13.218848397084725],[80.38095474243164,13.218848397084725],[80.38048267364502,13.218848397084725],[80.3800106048584,13.218890175328857],[80.37971019744873,13.219182622837401],[80.37928104400633,13.219224401024285],[80.37872314453125,13.219391513700256],[80.37825107574463,13.219600404384208],[80.37795066833495,13.2196839606077],[80.37726402282715,13.219809294889263],[80.37692070007324,13.220018185215416],[80.37662029266357,13.220101741295782],[80.37627696990967,13.220310631371461],[80.37576198577881,13.220310631371461],[80.3754186630249,13.220519521268226],[80.37490367889404,13.22072841098608],[80.37443161010742,13.220853744730917],[80.37408828735352,13.220937300525021],[80.37374496459961,13.221146189885049],[80.37318706512451,13.221271523415174],[80.37275791168213,13.221480412488914],[80.37237167358397,13.221814634634754],[80.37181377410889,13.221981745535885],[80.37112712860107,13.222441299923545],[80.37056922912598,13.222608410395251],[80.37035465240479,13.222733743173874],[80.36988258361816,13.222900853445154],[80.3695821762085,13.223067963601922],[80.36923885345459,13.22327685113682],[80.36893844604492,13.223485738492782],[80.36786556243896,13.22394529004597],[80.36687850952148,13.224404840733005],[80.3666639328003,13.224739058870455],[80.36636352539062,13.224864390553872],[80.36597728729248,13.225115053727444],[80.36559104919434,13.225491048004557],[80.36524772644043,13.22582526465296],[80.36503314971924,13.226075926838575],[80.36486148834229,13.226284811796372],[80.36468982696533,13.226744358073505],[80.36486148834229,13.226869688726016],[80.36503314971924,13.227078573003645],[80.3653335571289,13.227245680296882],[80.3655481338501,13.227245680296882],[80.36580562591551,13.227496341021936],[80.36606311798096,13.22757989453968],[80.36632061004639,13.227705224762586]]}},{"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[80.34954071044922,13.271002955567292],[80.3494119644165,13.270877647642543],[80.34928321838379,13.270668800957644],[80.3491759300232,13.270439069396911],[80.3490686416626,13.270313761181304],[80.348961353302,13.270125798736704],[80.34887552261353,13.269979605623698],[80.34874677658081,13.269770758166791],[80.34863948822021,13.26958279530209],[80.34853219985962,13.269415717078054],[80.34846782684326,13.269227753938667],[80.34836053848265,13.269123329909505],[80.34823179244995,13.26889359688737],[80.34814596176147,13.268705633344053],[80.34801721572875,13.268517669655333],[80.34801721572875,13.268371475574689],[80.34801721572875,13.268120856946082],[80.348060131073,13.267828468219328],[80.34810304641724,13.267619618913374],[80.34810304641724,13.26734811454728],[80.34810304641724,13.26707660987784],[80.34812450408936,13.266867759925686],[80.34812450408936,13.266658909794046],[80.34812450408936,13.266429174441914],[80.34814596176147,13.266241208992275],[80.3481674194336,13.266053243397245],[80.34818887710571,13.265907047833927],[80.34818887710571,13.265698196876642],[80.34821033477783,13.265552001099756],[80.34818887710571,13.265364034971665],[80.34824788570404,13.265176068698198],[80.34823179244995,13.264904561602096],[80.34829080104828,13.264633054202696],[80.34830689430237,13.264382431718673],[80.34829616546631,13.264152694214614],[80.34833908081055,13.263881185975318],[80.34833908081055,13.263630562716015],[80.34838199615477,13.263484365695431],[80.34836053848265,13.263296397968311],[80.3484034538269,13.26312931542218],[80.3484034538269,13.262920462078016],[80.34844636917114,13.26281603533864],[80.34846246242522,13.262711608554403],[80.34846246242522,13.262628067094717],[80.34847855567932,13.262534082918252],[80.34848392009735,13.262408770626434],[80.34851610660553,13.262226023418412],[80.34853219985962,13.262001505231913],[80.34853219985962,13.261792650918773],[80.3485643863678,13.261625567339077],[80.34859120845795,13.261369720385098],[80.34860730171204,13.261098209037433],[80.34863948822021,13.260873689809355],[80.3486555814743,13.260675277295679],[80.34869313240051,13.260398543782498],[80.34870386123656,13.260205352275284],[80.34874677658081,13.259787640383541],[80.34874677658081,13.259474355993795],[80.34878969192505,13.259223728191374],[80.34878969192505,13.258993985812214],[80.34883260726929,13.258785128915509],[80.3488540649414,13.258597157555101],[80.3488540649414,13.258409186049379],[80.34893989562988,13.258179442900614],[80.34898281097412,13.257949699534807],[80.34900426864623,13.257657298573477],[80.34909009933472,13.257344011439052],[80.34915447235107,13.25703072390104],[80.34919738769531,13.256800979449977],[80.34926176071167,13.256571234781898],[80.34926176071167,13.256341489896778],[80.34934759140013,13.256049087001823],[80.34936904907227,13.255902885422525],[80.3494119644165,13.255714911834279],[80.3494119644165,13.25552693810077],[80.34947633743286,13.255276306230089],[80.34949779510498,13.255067446140579],[80.34956216812134,13.254900357939842],[80.34960508346558,13.254691497527505],[80.3496265411377,13.254419978723348],[80.34969091415404,13.254252890077842],[80.34971237182617,13.254064915214448],[80.34975528717041,13.253835167961926],[80.34979820251465,13.253584534348061],[80.34992694854736,13.253208583443078],[80.34992694854736,13.253041493965476],[80.34994840621948,13.252853518165994],[80.35001277923583,13.252623769769375],[80.35003423690796,13.252456679890107],[80.3500771522522,13.25228958989606],[80.35012006759644,13.252101613515604],[80.35014152526855,13.251955409563726],[80.35020589828491,13.251725660318957],[80.35022735595703,13.251558569822851],[80.35024881362915,13.25132882020335],[80.35029172897339,13.251182615787059],[80.35035610198975,13.250973752182832],[80.35037755966187,13.250785774785706],[80.3504204750061,13.250660456440286],[80.35044193267822,13.250430705972722],[80.35050630569458,13.25022184172302],[80.35054922103882,13.249908545012339],[80.3506350517273,13.249637020870106],[80.35069942474365,13.249323723406436],[80.35074234008789,13.249156631260881],[80.35076379776001,13.248989539000574],[80.35080671310425,13.24882244662555],[80.3508710861206,13.2485718078479],[80.35095691680908,13.248237622409466],[80.35097837448119,13.248091416135848],[80.35102128982544,13.24794520977438],[80.3509998321533,13.24807052951815],[80.35106420516968,13.247778116682309],[80.35115003585815,13.247443930153974],[80.35119295120239,13.247235063340744],[80.35125732421875,13.247067969761105],[80.3513216972351,13.24683821590177],[80.35136461257935,13.24660846182556],[80.35145044326782,13.246378707532473],[80.35151481628418,13.246232500142137],[80.35160064697266,13.2460236322893],[80.35164356231688,13.24579387744417],[80.35170793533325,13.245543235547592],[80.35177230834961,13.24537614080649],[80.35183668136597,13.245188159085641],[80.35190105438232,13.244979290336664],[80.35198688507079,13.244728647601322],[80.35205125808716,13.244603326136874],[80.35215854644775,13.24443623075059],[80.35222291946411,13.244143813548572],[80.35228729248047,13.243976717846879],[80.3523302078247,13.243809622030469],[80.3524374961853,13.243621639099928],[80.35252332687378,13.243370994966746],[80.35256624221802,13.243141237617975],[80.35265207290648,13.242890592990191],[80.35269498825073,13.242639948104388],[80.35278081893921,13.242410190065716],[80.35290956497192,13.242201318933319],[80.35297393798827,13.241950673337922],[80.353102684021,13.24163736598083],[80.35316705703735,13.24140760699607],[80.35323143005371,13.241198735003612],[80.35329580307005,13.241094298940197],[80.35338163375854,13.240885426678972],[80.35342454910278,13.240634779729014],[80.35348892211914,13.24046768161903],[80.35359621047974,13.240175259650659],[80.35368204116821,13.239945499286312],[80.35370349884033,13.239757513372412],[80.35381078720093,13.239548639964557],[80.3538966178894,13.239318879008998],[80.35398244857788,13.238984680868496],[80.35402536392212,13.238796694212915],[80.35408973693848,13.238608707412238],[80.35413265228271,13.238483382797844],[80.35421848297119,13.238337170666203],[80.35428285598753,13.238044746139597],[80.35436868667603,13.237752321261882],[80.3544545173645,13.23752255861166],[80.35454034805298,13.237209245557521],[80.35458326339722,13.237063032660995],[80.35458326339722,13.236833269360552],[80.35471200942993,13.236582618240163],[80.35484075546265,13.236206641075974],[80.35494804382323,13.23585155099915],[80.35499095916748,13.235642674241586],[80.35505533218384,13.235392021896084],[80.35516262054443,13.235078706101543],[80.35524845123291,13.234828053175768],[80.3553557395935,13.234556512215155],[80.35550594329834,13.234326746550556],[80.35563468933105,13.234138756300146],[80.35587072372437,13.23390899024154],[80.35608530044556,13.233574784678591],[80.35632133483887,13.23336590596893],[80.35653591156006,13.233177914977132],[80.35666465759277,13.233010811751557],[80.35685777664185,13.232781044629245],[80.35698652267456,13.232655717016659],[80.35707235336304,13.232572165239125],[80.35724401473998,13.23236328566995],[80.35741567611694,13.232154405921698],[80.35754442214966,13.232029077986805],[80.35769462585449,13.231841085963593],[80.35799503326416,13.23159042970704],[80.35840272903442,13.231360661245372],[80.35874605178833,13.231235332902223],[80.35900354385376,13.231193556773528],[80.35941123962402,13.23100556410573],[80.35969018936157,13.23090112367207],[80.36014080047607,13.230650466448665],[80.36035537719727,13.230608690219693],[80.3605270385742,13.230587802102518],[80.36078453063965,13.230483361489828],[80.36099910736084,13.230358032695486],[80.36114931106567,13.230253591984328],[80.3614068031311,13.230211815687317],[80.36168575286865,13.230128263071833],[80.36187887191772,13.229982045925794],[80.36224365234375,13.229794052323424],[80.36243677139282,13.229731387757079],[80.36265134811401,13.229626946777353],[80.36290884017944,13.229564282168033],[80.36312341690063,13.229459841116695],[80.36333799362183,13.229438952901061],[80.36357402801514,13.22931362356965],[80.36381006240843,13.229209182410898],[80.36404609680176,13.229125629451675],[80.36434650421143,13.229021188212364],[80.36428213119507,13.229250958879772],[80.36413192749022,13.229418064683633],[80.36393880844116,13.229647834976868],[80.36385297775269,13.229814940508613],[80.36370277404785,13.229982045925794],[80.3635311126709,13.230211815687317],[80.36338090896606,13.230441585232207],[80.36329507827759,13.230629578335076],[80.36314487457274,13.230775795092592],[80.3629732131958,13.230963787937648],[80.36280155181885,13.231277109023768],[80.36265134811401,13.231465101482081],[80.36247968673706,13.23169486984528],[80.36232948303223,13.231882861981287],[80.36222219467163,13.232091741962305],[80.36211490631104,13.232217069864971],[80.36209344863892,13.231987301994174],[80.36209344863892,13.23169486984528],[80.36205053329468,13.231381549296291],[80.36205053329468,13.231110004494637],[80.3620719909668,13.230775795092592],[80.3620719909668,13.230525137740274],[80.3620719909668,13.230211815687317],[80.36200761795044,13.230044710427688],[80.36198616027832,13.229626946777353],[80.36198616027832,13.229418064683633],[80.36198616027832,13.229083852961324],[80.36194324493408,13.228770529055426],[80.36198616027832,13.228498981344504],[80.36198616027832,13.228269209968202],[80.36192178726196,13.227934996670552],[80.36190032958984,13.227684336396576],[80.36190032958984,13.227600782914633],[80.36190032958984,13.227371010691629],[80.36190032958984,13.227162126664576],[80.36190032958984,13.226932354028087],[80.36190032958984,13.226702581175013],[80.36190032958984,13.226451919633751],[80.36187887191772,13.22624303481913],[80.36187887191772,13.225950595777986],[80.36183595657347,13.22559549075641],[80.36179304122925,13.225365716643278],[80.36179304122925,13.225198608061357],[80.36172866821289,13.224885279161516],[80.36172866821289,13.224592838491699],[80.36172866821289,13.22446750666868],[80.36170721054077,13.224300397471104],[80.36168575286865,13.22394529004597],[80.36164283752441,13.22375729178798],[80.36157846450806,13.223423072304787],[80.36157846450806,13.223255962391383],[80.36155700683594,13.222942630995087],[80.3615355491638,13.222733743173874],[80.36151409149169,13.222483077552216],[80.36151409149169,13.222315966994623],[80.36147117614746,13.22193996782134],[80.36142826080322,13.221751968017294],[80.3616213798523,13.2215848569587],[80.36179304122925,13.221501301386446],[80.36190032958984,13.22137596797441],[80.36205053329468,13.221208856658166],[80.36215782165526,13.221146189885049],[80.36235094070435,13.221020856290501],[80.36247968673706,13.220874633682124],[80.36269426345825,13.22072841098608],[80.3628659248352,13.22056129922611],[80.36310195922852,13.220289742371934],[80.36333799362183,13.220185297347511],[80.36350965499878,13.220039074238185],[80.36368131637573,13.219913740074698],[80.36383152008055,13.219788405846812],[80.36402463912964,13.219642182499529],[80.36417484283447,13.219558626261724],[80.3643250465393,13.219391513700256],[80.36451816558838,13.219224401024285],[80.36479711532591,13.219036399126963],[80.36514043807982,13.218785729705116],[80.3653335571289,13.218660394897604],[80.36559104919434,13.218493281720722],[80.36580562591551,13.218284390088646],[80.36608457565308,13.218075498277669],[80.36636352539062,13.217908384700088],[80.36662101745605,13.217699492567125],[80.36692142486572,13.217427932526848],[80.36713600158691,13.217323486277007],[80.36726474761963,13.217239929244956],[80.36747932434082,13.217156372184265],[80.36762952804565,13.217051925818183],[80.36777973175047,13.216822143655358],[80.36810159683226,13.21661325059226],[80.36831617355347,13.216425246682553],[80.3684663772583,13.216299910662245],[80.36874532699584,13.216091017152],[80.36906719207762,13.21586123408413],[80.36932468414307,13.21567322959491],[80.36945343017578,13.21558967199765],[80.36968946456909,13.215422556717263],[80.36986112594604,13.21533899903415],[80.3701400756836,13.215130104701172],[80.37061214447021,13.215109215258048],[80.37097692489624,13.215025657467612],[80.37123441696167,13.215046546917913],[80.37162065505981,13.215025657467612],[80.37202835083006,13.214942099648576],[80.3723931312561,13.214879431265528],[80.37267208099365,13.214879431265528],[80.37310123443604,13.214691426019783],[80.37387371063232,13.214586978598442],[80.3744101524353,13.214482531132395],[80.37466764450072,13.214482531132395],[80.37501096725462,13.21437808362163],[80.37531137466429,13.21437808362163],[80.3755259513855,13.214294525580835],[80.3758692741394,13.214294525580835],[80.37610530853271,13.214252746549704],[80.37647008895874,13.2141900779896],[80.37685632705688,13.214169188465982],[80.37724256515503,13.214127409413392],[80.37762880325316,13.21408563035365],[80.37780046463013,13.214064740821101],[80.37822961807251,13.213960293131512],[80.37874460220337,13.213834955844987],[80.37917375564575,13.213814066290963],[80.37936687469482,13.213814066290963],[80.37968873977661,13.213751397618203],[80.38003206253052,13.21373050805703],[80.38018226623535,13.213709618494075],[80.38041830062866,13.21366783936281],[80.38063287734985,13.213584281078802],[80.38091182708739,13.21354250192606],[80.38114786148071,13.213521612346998],[80.3814697265625,13.213438054012942],[80.38179159164429,13.213438054012942],[80.38189888000487,13.213417164424937]]}}]}
// Used to increment the value of the point measurement against the route.
var counter = 0;

map.on('load', function () {
    
        map.addSource("paths", {
            "type": "geojson",
            "data": "data/map.geojson"
        });

        var dawn_point = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": dawn
                }
            }]
        };

        map.addSource('dawn', {
            "type": "geojson",
            "data": dawn_point
        });

        map.addLayer({
        "id": "dawn",
        "source": "dawn",
        "type": "circle",
        "paint": {
            "circle-radius": initialRadius,
            "circle-radius-transition": {duration: 0},
            "circle-opacity-transition": {duration: 0},
            "circle-color": "#199280"
        }
    });

    map.addLayer({
        "id": "dawn1",
        "source": "dawn",
        "type": "circle",
        "paint": {
            "circle-radius": initialRadius,
            "circle-color": "#199280"
        }
    });

        var maple_point = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": maple
                }
            }]
        };

        map.addSource('maple', {
            "type": "geojson",
            "data": maple_point
        });

    map.addLayer({
        "id": "maple",
        "source": "maple",
        "type": "circle",
        "paint": {
            "circle-radius": initialRadius,
            "circle-radius-transition": {duration: 0},
            "circle-opacity-transition": {duration: 0},
            "circle-color": "#199280"
        }
    });

    map.addLayer({
        "id": "maple1",
        "source": "maple",
        "type": "circle",
        "paint": {
            "circle-radius": initialRadius,
            "circle-color": "#199280"
        }
    });

    function doMapthings(){
        console.log('doing things')
        setTimeout(function(){ map.flyTo({ zoom: ($(window).width()<600)?11:(12), center: centernew, duration: 3000}) }, 5000);
        map.flyTo({ zoom: 10, center: chennai, duration: 3000});
        function animateMarker(timestamp) {
            setTimeout(function(){
                requestAnimationFrame(animateMarker);

                radius += (maxRadius - radius) / framesPerSecond;
                opacity -= ( .9 / framesPerSecond );

                map.setPaintProperty('dawn', 'circle-radius', radius);
                map.setPaintProperty('dawn', 'circle-opacity', opacity);

                map.setPaintProperty('maple', 'circle-radius', radius);
                map.setPaintProperty('maple', 'circle-opacity', opacity);

                if (opacity <= 0.1) {
                    radius = initialRadius;
                    opacity = initialOpacity;
                } 

            }, 1000 / framesPerSecond);
            
        }

        // Start the animation.
        animateMarker(0);


        function animate_d() {
            // Update point geometry to a new position based on counter denoting
            // the index to access the arc.
            dawn_point.features[0].geometry.coordinates = json.features[0].geometry.coordinates[counter];

            // Update the source with this new data.
            map.getSource('dawn').setData(dawn_point);

            // Request the next frame of animation so long as destination has not
            // been reached.
            if (dawn_point.features[0].geometry.coordinates[0] !== dawndest[0]) {
                setTimeout(function(){
                requestAnimationFrame(animate_d);
                }, 50)
            } else {

            }

                counter = counter + 1;

                if (counter==20){
                    $('.time span').text('3:05')
                } else if(counter==40){
                    $('.time span').text('3:09')
                } else if(counter==60){
                    $('.time span').text('3:11')
                } else if(counter==80){
                    $('.time span').text('3:15')
                } else if(counter==100){
                    $('.time span').text('3:19')
                } else if(counter==120){
                    $('.time span').text('3:23')
                } else if(counter==140){
                    $('.time span').text('3:27')
                } else if(counter==160){
                    $('.time span').text('3:32')
                } else if(counter==175){
                    $('.time span').text('3:36')
                } else if(counter==190){
                    $('.time span').text('3:40')
                }
                if (counter==206){
                    $('.time span').text('3:45')
                    $('.scroll').addClass('show')
                }
            // }
            
        }

        function animate_m() {
            // Update point geometry to a new position based on counter denoting
            // the index to access the arc.
            maple_point.features[0].geometry.coordinates = json.features[1].geometry.coordinates[counter];

            // Update the source with this new data.
            map.getSource('maple').setData(maple_point);

            // Request the next frame of animation so long as destination has not
            // been reached.
            if (maple_point.features[0].geometry.coordinates[0] !== mapledest[0]) {
                setTimeout(function(){
            requestAnimationFrame(animate_m);
        }, 50)
            }
        }
        setTimeout(function(){
            animate_d(counter);
            animate_m(counter);
        }, 8000)
    }
    $(window).scroll(function() {
        var windscroll = $(window).scrollTop();
    if ($('.map-container').position().top <= windscroll + buffer  && $('#map').hasClass('active')){
            doMapthings()
            $('#map').removeClass('active')
        }
    }).scroll();
});